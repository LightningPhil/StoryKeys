<!DOCTYPE html>
<html lang="en-GB" class="theme-cream">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryKeys</title>
    <!--
      StoryKeys: A dyslexia-friendly typing app.
      Version 8.0: Feature Enhancements (Stage 2).
      All data is stored locally in your browser. Nothing is sent to a server.
    -->
    <style>
        /* --- GLOBAL STYLES & DYSLEXIA-FRIENDLY DEFAULTS (from PRD) --- */
        :root {
            --font-family-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-family-dyslexia: "Arial", sans-serif;
            --base-font-size: clamp(16px, 1.8vw, 20px);
            --border-radius: 12px;
            --max-width: 800px;
            --transition-speed: 200ms;
        }

        .theme-light { --color-bg: #f8f9fa; --color-text: #212529; --color-card-bg: #ffffff; --color-subtle-bg: #e9ecef; --color-border: #dee2e6; --color-accent: #3b82f6; }
        .theme-cream { --color-bg: #FAF9F4; --color-text: #1a1a1a; --color-card-bg: #ffffff; --color-subtle-bg: #f0efe9; --color-border: #dcdad1; --color-accent: #3b82f6; }
        .theme-dark { --color-bg: #0E1116; --color-text: #E8ECF1; --color-card-bg: #161b22; --color-subtle-bg: #21262d; --color-border: #30363d; --color-accent: #60a5fa; }

        @media (prefers-reduced-motion: reduce) { * { transition: none !important; animation: none !important; } }

        * { box-sizing: border-box; }

        html { font-family: var(--font-family, var(--font-family-default)); font-size: var(--base-font-size); line-height: var(--line-height, 1.7); letter-spacing: var(--letter-spacing, 0.02em); background-color: var(--color-bg); color: var(--color-text); transition: background-color var(--transition-speed), color var(--transition-speed); scroll-behavior: smooth; }
        body { margin: 0; padding: 1rem; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        #app-container { width: 100%; max-width: var(--max-width); position: relative; }

        /* --- UI COMPONENTS --- */
        .card { background-color: var(--color-card-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 1.5rem 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .button { display: inline-block; font-size: 1rem; font-weight: 600; text-decoration: none; padding: 0.8rem 1.5rem; border-radius: var(--border-radius); border: 2px solid transparent; cursor: pointer; transition: all var(--transition-speed) ease; text-align: center; }
        .button-primary { background-color: var(--color-accent); color: white; border-color: var(--color-accent);}
        .button-primary:hover { opacity: 0.85; }
        .button-secondary { background-color: var(--color-subtle-bg); border-color: var(--color-border); color: var(--color-text); }
        .button-secondary:hover { background-color: var(--color-border); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .icon-button { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .icon-button:hover { background-color: var(--color-subtle-bg); }
        .icon-button svg { width: 24px; height: 24px; fill: var(--color-text); }
        .button:focus-visible, .icon-button:focus-visible, .toggle-switch:focus-within { outline: 3px solid var(--color-accent); outline-offset: 2px; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }

        h1, h2, h3 { margin: 0 0 1rem 0; line-height: 1.2; }
        p { margin: 0 0 1rem 0; max-width: 65ch; }
        .screen { display: none; flex-direction: column; gap: 2rem; }
        .screen.active { display: flex; }
        
        /* --- HEADER & MODALS --- */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin-bottom: 1rem; }
        .app-title { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.active { display: flex; }
        .modal-content { background: var(--color-card-bg); border-radius: var(--border-radius); padding: 2rem; max-width: 95%; width: 600px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-shrink: 0; }
        
        /* --- HOME SCREEN --- */
        .home-header { text-align: center; margin-bottom: 1rem; }
        .home-header h1 { font-size: 2.5rem; }
        .home-header p { font-size: 1.1rem; opacity: 0.8; max-width: 45ch; margin: auto; }
        .home-card { text-align: center; }
        .home-card p { opacity: 0.7; }
        .progress-card { display: flex; align-items: center; justify-content: center; gap: 1.5rem; text-align: left; }
        .progress-pet { font-size: 3rem; }

        /* --- TYPING & DRILL SCREENS --- */
        .typing-target { font-size: 1.5rem; background-color: var(--color-subtle-bg); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem; line-height: 1.8; letter-spacing: 0.05em; white-space: pre-wrap; word-break: break-word; }
        .typing-target.focus-line-active .line:not(.current-line) { opacity: 0.5; }
        .typing-target .line { transition: opacity 0.2s; }
        .typing-target .char { transition: color 0.1s, background-color 0.1s; }
        .char.correct { color: #16a34a; }
        .char.incorrect { color: #ef4444; text-decoration: underline wavy #ef4444; text-decoration-thickness: 2px; text-underline-offset: 3px; }
        .char.current { background-color: rgba(59, 130, 246, 0.2); border-radius: 3px; }
        .typing-input { width: 100%; font-family: inherit; font-size: 1.5rem; line-height: 1.8; letter-spacing: 0.05em; padding: 1rem; border: 2px solid var(--color-border); border-radius: var(--border-radius); outline: none; resize: none; background-color: var(--color-card-bg); color: var(--color-text); }
        .typing-input:focus { border-color: var(--color-accent); }
        .typing-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .next-key-bubble { display: inline-block; background-color: var(--color-text); color: var(--color-bg); padding: 0.4rem 1rem; border-radius: 2rem; font-weight: bold; font-size: 1rem; }
        .timer-chip { font-size: 1.2rem; font-weight: bold; background-color: var(--color-subtle-bg); padding: 0.5rem 1rem; border-radius: 2rem; }
        .toggle-switch { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none; border-radius: 99px; padding: 0.25rem; }
        .toggle-switch input { position: absolute; opacity: 0; width: 0; height: 0; }
        .toggle-switch .slider { width: 34px; height: 20px; background-color: #ccc; border-radius: 10px; position: relative; transition: background-color 0.2s; }
        .toggle-switch .slider::before { content: ''; position: absolute; width: 16px; height: 16px; border-radius: 50%; background-color: white; top: 2px; left: 2px; transition: transform 0.2s; }
        .toggle-switch input:checked + .slider { background-color: var(--color-accent); }
        .toggle-switch input:checked + .slider::before { transform: translateX(14px); }

        /* --- SUMMARY & BADGES --- */
        .summary-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.5rem; text-align: center; margin: 2rem 0; }
        .metric-item .value { font-size: 2.5rem; font-weight: bold; }
        .summary-feedback ul { list-style-type: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .summary-feedback li { background-color: var(--color-subtle-bg); padding: 0.25rem 0.75rem; border-radius: 1rem; }
        .badge-earned { position: relative; border: 2px solid #f59e0b; padding: 1rem; text-align: center; border-radius: var(--border-radius); background-color: var(--color-subtle-bg); overflow: hidden; animation: badge-pulse 1.5s ease-out; }
        @keyframes badge-pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 30% { transform: scale(1.05); } 60% { transform: scale(1); box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); } 100% { transform: scale(1); } }
        
        /* --- KEYBOARD HINT --- */
        #keyboard-hint { margin-top: 2rem; padding: 0.5rem; background: var(--color-subtle-bg); border-radius: var(--border-radius); user-select: none; }
        .keyboard-row { display: flex; justify-content: center; margin: 5px 0; }
        .key { display: inline-block; min-width: 50px; height: 50px; line-height: 50px; text-align: center; border: 1px solid var(--color-border); background: var(--color-card-bg); margin: 2px; border-radius: 5px; font-size: 1rem; transition: all 0.1s; }
        .key.space { width: 280px; }
        .key.highlight { background-color: var(--color-accent); color: white; transform: scale(1.1); }
        
        /* --- CONFETTI & TOAST --- */
        .confetti { position: absolute; width: 10px; height: 10px; background-color: var(--color-accent); opacity: 0; animation: confetti-fall 2s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100px) rotate(360deg); opacity: 0; } }
        .toast { position:fixed; bottom:1rem; left:50%; transform:translateX(-50%); background:var(--color-text); color:var(--color-bg); padding:.5rem 1rem; border-radius:999px; z-index: 101; }
        
        /* --- STAGE 2: LESSON PICKER ENHANCEMENTS --- */
        .search-sort-container { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .search-input { flex-grow: 1; font-size: 1rem; padding: 0.6rem 1rem; border: 2px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-subtle-bg); }
        .search-input:focus { border-color: var(--color-accent); background-color: var(--color-card-bg); outline: none; }
        .sort-select { font-size: 1rem; padding: 0.6rem; border: 2px solid var(--color-border); border-radius: var(--border-radius); background-color: var(--color-subtle-bg); cursor: pointer; }
        .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border); }
        .lesson-list.loading { opacity: 0.5; transition: opacity 150ms; }
        .lesson-list .no-results { text-align: center; opacity: 0.7; padding: 2rem; }

        /* --- POLISHED MODAL STYLES --- */
        .tabs { display: flex; border-bottom: 1px solid var(--color-border); margin-bottom: 1.5rem; }
        .tab-button { padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; font-size: 1rem; border-bottom: 3px solid transparent; color: var(--color-text); opacity: 0.6; }
        .tab-button.active { border-bottom-color: var(--color-accent); font-weight: bold; opacity: 1; }
        .lesson-list { flex-grow: 1; overflow-y: auto; }
        .lesson-item { display: flex; gap: 1rem; align-items: center; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 0.5rem; cursor: pointer; transition: background-color var(--transition-speed); }
        .lesson-item:hover { background-color: var(--color-subtle-bg); }
        .lesson-icon { font-size: 1.5rem; flex-shrink: 0; }
        .lesson-details { flex-grow: 1; }
        .lesson-details b { display: block; }
        .lesson-meta { display: flex; gap: 0.5rem; font-size: 0.8rem; opacity: 0.7; margin-top: 0.25rem; }
        .meta-chip { background-color: var(--color-subtle-bg); padding: 0.1rem 0.5rem; border-radius: 99px; }
        .filter-group { display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; }
        .filter-group label { font-weight: bold; }
        .stage-filter .button { padding: 0.5rem 1rem; }
        .stage-filter .button.active { background-color: var(--color-accent); color: white; }
        .settings-section { margin-bottom: 1rem; border-top: 1px solid var(--color-border); padding-top: 1.5rem; }
        .settings-section summary { font-weight: bold; font-size: 1.2rem; cursor: pointer; list-style: none; }
        .settings-section summary::-webkit-details-marker { display: none; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; }
        .setting-item p { margin: 0; opacity: 0.7; font-size: 0.9rem; }

        /* --- LOADING OVERLAY --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--color-bg);
            color: var(--color-text);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: bold; z-index: 200;
            transition: opacity 300ms;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <p>Loading StoryKeys...</p>
        <p id="loading-error" style="display:none; font-size: 1rem; color: #ef4444;"></p>
    </div>

    <div id="app-container" style="display: none;">
        <header class="app-header">
            <div class="app-title"><span id="progress-pet"></span> StoryKeys</div>
            <div class="button-group">
                <button id="settings-btn" class="icon-button" title="Settings"><svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.22,5.25C8.63,5.5,8.1,5.82,7.6,6.2L5.21,5.24C4.99,5.16,4.74,5.23,4.62,5.45L2.7,8.77 c-0.12,0.21-0.07,0.47,0.12,0.61l2.03,1.58C4.82,11.36,4.8,11.68,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.38,2.44 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44,0.17-0.48,0.41l0.38-2.44c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.2,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path></svg></button>
                <button id="parent-btn" class="icon-button" title="Parent Glance"><svg viewBox="0 0 24 24"><path d="M12,12c2.21,0,4-1.79,4-4s-1.79-4-4-4S8,5.79,8,8S9.79,12,12,12z M12,14c-2.67,0-8,1.34-8,4v2h16v-2 C20,15.34,14.67,14,12,14z"></path></svg></button>
            </div>
        </header>
        <main id="main-content"></main>
        <div id="modal-container"></div>
    </div>
    
    <script src="src/main.js" type="module"></script>

</body>
</html>